<template>
  <b-container fluid="xl">
    <page-title :title="$t('appPageTitle.userManagement')" />
    <b-row v-if="isAdminUser || isServiceUser">
      <b-col>
        <span>{{ $t('pageUserManagement.mfaTotpAuthentication') }}</span>
        <info-tooltip
          v-if="!globalMfaValue && !currentMfaBypassed"
          class="ml-1"
          :title="$t('pageUserManagement.enableMfaInfo')"
        >
        </info-tooltip>
        <b-form-checkbox
          id="switch"
          ref="globalMfaRef"
          v-model="globalMfaValue"
          :disabled="isBusy"
          switch
          class="mt-1"
          @change="updateGlobalMfa"
        >
          <span v-if="globalMfaValue">
            {{ $t('global.status.enabled') }}
          </span>
          <span v-else>{{ $t('global.status.disabled') }}</span>
        </b-form-checkbox>
      </b-col>
    </b-row>
    <b-row v-if="isAdminUser || isServiceUser" class="mt-2">
      <b-col xl="9">
        <alert variant="info" class="mb-2">
          <div>
            {{ $t('pageUserManagement.modal.hmcWarning') }}
          </div>
        </alert>
      </b-col>
    </b-row>
    <b-row
      v-if="isAdminUser && globalMfaValue && currentMfaBypassed"
      class="mt-2"
    >
      <b-col xl="9">
        <alert variant="warning" class="mb-4">
          <div>
            {{ $t('pageUserManagement.disableMfaBypassWarning') }}
          </div>
        </alert>
      </b-col>
    </b-row>
    <b-row>
      <b-col xl="9" class="text-right">
        <b-button variant="link" :disabled="isBusy" @click="initModalSettings">
          <icon-settings />
          {{ $t('pageUserManagement.accountPolicySettings') }}
        </b-button>
        <b-button
          variant="primary"
          :disabled="isBusy"
          data-test-id="userManagement-button-addUser"
          @click="initModalUser(null)"
        >
          <icon-add />
          {{ $t('pageUserManagement.addUser') }}
        </b-button>
      </b-col>
    </b-row>
    <b-row>
      <b-col xl="9">
        <table-toolbar
          ref="toolbar"
          :selected-items-count="selectedRows.length"
          :actions="tableToolbarActions"
          @clear-selected="clearSelectedRows($refs.table)"
          @batch-action="onBatchAction"
        />
        <b-table
          ref="table"
          responsive="md"
          selectable
          show-empty
          no-select-on-click
          hover
          :busy="isBusy"
          :fields="fields"
          :items="tableItems"
          :empty-text="$t('global.table.emptyMessage')"
          @row-selected="onRowSelected($event, tableItems.length)"
        >
          <!-- Checkbox column -->
          <template #head(checkbox)>
            <b-form-checkbox
              v-model="tableHeaderCheckboxModel"
              data-test-id="userManagement-checkbox-tableHeaderCheckbox"
              :indeterminate="tableHeaderCheckboxIndeterminate"
              @change="onChangeHeaderCheckbox($refs.table)"
            >
              <span class="sr-only">{{ $t('global.table.selectAll') }}</span>
            </b-form-checkbox>
          </template>
          <template #cell(checkbox)="row">
            <b-form-checkbox
              v-model="row.rowSelected"
              data-test-id="userManagement-checkbox-toggleSelectRow"
              @change="toggleSelectRow($refs.table, row.index)"
            >
              <span class="sr-only">{{ $t('global.table.selectItem') }}</span>
            </b-form-checkbox>
          </template>
          <template v-if="isAdminUser || isServiceUser" #cell(mfa)="row">
            <b-form-checkbox
              v-if="row.item.privilege !== 'Service agent'"
              v-model="row.item.mfa"
              b-form-checkbox
              switch
              @change="updateMfaBypassVal(row.item)"
            >
            </b-form-checkbox>
          </template>
          <template #head(secretKey)="row">
            {{ row.label }}
            <info-tooltip
              v-if="isAdminUser || isServiceUser"
              class="ml-1"
              :title="$t('pageUserManagement.table.secretKeyTooltip')"
            >
            </info-tooltip>
          </template>
          <template v-if="isAdminUser || isServiceUser" #cell(secretKey)="row">
            <b-button
              v-if="
                row.item.privilege !== 'Service agent' &&
                currentUser.UserName !== row.item.username
              "
              variant="primary"
              :disabled="!row.item.secretKey"
              @click="clearSecretKey(row.item)"
            >
              {{ $t('pageUserManagement.table.clear') }}
            </b-button>
          </template>

          <!-- table actions column -->
          <template #cell(actions)="{ item }">
            <table-row-action
              v-for="(action, index) in item.actions"
              :key="index"
              :value="action.value"
              :enabled="action.enabled"
              :title="action.title"
              @click-table-action="onTableRowAction($event, item)"
            >
              <template #icon>
                <icon-edit
                  v-if="action.value === 'edit'"
                  :data-test-id="`userManagement-tableRowAction-edit-${index}`"
                />
                <icon-trashcan
                  v-if="action.value === 'delete'"
                  :data-test-id="`userManagement-tableRowAction-delete-${index}`"
                />
              </template>
            </table-row-action>
          </template>
        </b-table>
      </b-col>
    </b-row>
    <b-row>
      <b-col xl="8">
        <b-button
          v-b-toggle.collapse-role-table
          data-test-id="userManagement-button-viewPrivilegeRoleDescriptions"
          variant="link"
          class="mt-3"
        >
          <icon-chevron />
          {{ $t('pageUserManagement.viewPrivilegeRoleDescriptions') }}
        </b-button>
        <b-collapse id="collapse-role-table" class="mt-3">
          <table-roles />
        </b-collapse>
      </b-col>
    </b-row>
    <!-- Modals -->
    <modal-settings :settings="settings" @ok="saveAccountSettings" />
    <modal-user
      :user="activeUser"
      :password-requirements="passwordRequirements"
      @ok="saveUser"
      @hidden="activeUser = null"
    />
    <register-otp-modal @disable-mfa="disableMFA()" />
  </b-container>
</template>

<script>
import IconTrashcan from '@carbon/icons-vue/es/trash-can/20';
import IconEdit from '@carbon/icons-vue/es/edit/20';
import IconAdd from '@carbon/icons-vue/es/add--alt/20';
import IconSettings from '@carbon/icons-vue/es/settings/20';
import IconChevron from '@carbon/icons-vue/es/chevron--up/20';

import ModalUser from './ModalUser';
import ModalSettings from './ModalSettings';
import PageTitle from '@/components/Global/PageTitle';
import TableRoles from './TableRoles';
import TableToolbar from '@/components/Global/TableToolbar';
import TableRowAction from '@/components/Global/TableRowAction';
import { TOTP } from 'totp-generator';

import BVTableSelectableMixin, {
  selectedRows,
  tableHeaderCheckboxModel,
  tableHeaderCheckboxIndeterminate,
} from '@/components/Mixins/BVTableSelectableMixin';
import BVToastMixin from '@/components/Mixins/BVToastMixin';
import LoadingBarMixin from '@/components/Mixins/LoadingBarMixin';
import RegisterOtpModal from './RegisterOtpModal';
import Alert from '../../../components/Global/Alert.vue';
import InfoTooltip from '@/components/Global/InfoTooltip';

export default {
  name: 'UserManagement',
  components: {
    IconAdd,
    IconChevron,
    IconEdit,
    IconSettings,
    IconTrashcan,
    InfoTooltip,
    ModalSettings,
    ModalUser,
    PageTitle,
    TableRoles,
    TableRowAction,
    TableToolbar,
    RegisterOtpModal,
    Alert,
  },
  mixins: [BVTableSelectableMixin, BVToastMixin, LoadingBarMixin],
  beforeRouteLeave(to, from, next) {
    this.hideLoader();
    next();
  },
  data() {
    return {
      beforeMfa: false,
      isBusy: true,
      activeUser: null,
      fields: [
        {
          key: 'checkbox',
        },
        {
          key: 'username',
          label: this.$t('pageUserManagement.table.username'),
        },
        {
          key: 'privilege',
          label: this.$t('pageUserManagement.table.privilege'),
        },
        {
          key: 'status',
          label: this.$t('pageUserManagement.table.status'),
        },
        {
          key: 'actions',
          label: '',
          tdClass: 'text-right text-nowrap',
        },
      ],
      tableToolbarActions: [
        {
          value: 'delete',
          label: this.$t('global.action.delete'),
        },
        {
          value: 'enable',
          label: this.$t('global.action.enable'),
        },
        {
          value: 'disable',
          label: this.$t('global.action.disable'),
        },
      ],
      selectedRows: selectedRows,
      tableHeaderCheckboxModel: tableHeaderCheckboxModel,
      tableHeaderCheckboxIndeterminate: tableHeaderCheckboxIndeterminate,
    };
  },
  computed: {
    secretKey() {
      return this.$store.getters['userManagement/secretKeyInfo'];
    },
    currentMfaBypassed() {
      return this.$store.getters['userManagement/isCurrentUserMfaBypassed'];
    },
    isAdminUser() {
      return this.$store.getters['global/isAdminUser'];
    },
    isServiceUser() {
      return this.$store.getters['global/isServiceUser'];
    },
    globalMfaValue: {
      get() {
        return this.$store.getters['userManagement/isGlobalMfaEnabled'];
      },
      set(newValue) {
        return newValue;
      },
    },
    accountRoles() {
      return this.$store.getters['userManagement/accountRoles'];
    },
    allUsers() {
      return this.$store.getters['userManagement/allUsers'].map((user) => {
        // Changing users' description with redfish role description
        const userDescription = this.accountRoles.filter((role) =>
          user.RoleId.includes(role)
        )[0];

        if (userDescription) user.Description = userDescription;

        return user;
      });
    },
    currentUser() {
      return this.$store.getters['global/currentUser'];
    },
    tableItems() {
      // transform user data to table data
      return this.allUsers.map((user) => {
        return {
          username: user.UserName,
          privilege:
            user.Description === 'Administrator'
              ? this.$t('pageUserManagement.table.administrator')
              : user.Description === 'ReadOnly'
              ? this.$t('pageUserManagement.table.readOnly')
              : user.Description === 'ServiceAgent'
              ? this.$t('pageUserManagement.table.serviceAgent')
              : user.Description,
          status: user.Locked
            ? this.$t('global.status.locked')
            : user.Enabled
            ? this.$t('global.status.enabled')
            : this.$t('global.status.disabled'),
          mfa: user?.MFABypass?.BypassTypes.includes('GoogleAuthenticator')
            ? true
            : false,
          secretKey: user?.SecretKeySet,
          actions: [
            {
              value: 'edit',
              enabled: true,
              title: this.$t('pageUserManagement.editUser'),
            },
            {
              value: 'delete',
              enabled: user.RoleId !== 'OemIBMServiceAgent',
              title: this.$tc('pageUserManagement.deleteUser'),
            },
          ],
          ...user,
        };
      });
    },
    settings() {
      return this.$store.getters['userManagement/accountSettings'];
    },
    passwordRequirements() {
      if (this.activeUser?.AccountTypes?.includes('IPMI')) {
        return {
          minLength: 8,
          maxLength: 20,
        };
      } else {
        return this.$store.getters[
          'userManagement/accountPasswordRequirements'
        ];
      }
    },
  },
  watch: {
    secretKey(value) {
      if (value !== null && this.beforeMfa) {
        const { otp } = TOTP.generate(value, { digits: 6 });
        this.$store
          .dispatch('userManagement/verifyRegisterTotp', {
            otpValue: otp.toString(),
          })
          .then(() => {
            this.$store
              .dispatch('userManagement/updateGlobalMfa', {
                globalMfa: true,
              })
              .then((message) => {
                this.successToast(message);
                if (!this.currentMfaBypassed) {
                  this.$store.dispatch('authentication/logout');
                }
              })
              .catch(({ message }) => this.errorToast(message));
          })
          .catch(() => {
            this.errorToast(
              this.$t('pageUserManagement.toast.errorEnableMfaAuto')
            );
            this.$bvModal.show('register-otp-modal');
          })
          .finally(() => {
            this.beforeMfa = false;
          });
      }
    },
  },
  created() {
    this.startLoader();
    Promise.all([
      this.$store.dispatch('userManagement/getAccountRoles'),
      this.$store.dispatch('userManagement/getUsers'),
      this.$store.dispatch('userManagement/checkCurrentUserMfaBypassed', {
        uri: this.currentUser['@odata.id'],
      }),
    ]).finally(() => {
      this.endLoader();
      this.isBusy = false;
    });
    this.$store.dispatch('userManagement/getAccountSettings');
    this.$store.dispatch('userManagement/getAccountRoles');
    this.addMfaBypass();
  },
  methods: {
    disableMFA() {
      // reset MFA value
      this.$refs.globalMfaRef.$refs.input.checked = false;
    },
    addMfaBypass() {
      if (this.isAdminUser || this.isServiceUser) {
        this.fields.splice(4, 0, {
          key: 'mfa',
          label: this.$t('pageUserManagement.table.mfaByPass'),
          class: 'text-center',
        });
        this.fields.splice(5, 0, {
          key: 'secretKey',
          label: this.$t('pageUserManagement.table.secretKey'),
          class: 'text-center',
        });
      }
    },
    clearSecretKey(value) {
      this.$store
        .dispatch('userManagement/clearSetSecretKey', value)
        .then((message) => {
          this.successToast(message);
          if (this.currentUser?.UserName === value.username) {
            this.$store.dispatch('authentication/logout');
          } else {
            this.$store.dispatch('userManagement/getUsers');
          }
        })
        .catch(({ message }) => this.errorToast(message));
    },
    updateMfaBypassVal(value) {
      this.$store
        .dispatch('userManagement/updateMfaBypass', value)
        .then((message) => {
          this.successToast(message);
          this.$store.dispatch('userManagement/checkCurrentUserMfaBypassed', {
            uri: this.currentUser['@odata.id'],
          });
          this.$store.dispatch('userManagement/getUsers');
          if (
            this.currentUser?.UserName === value.username &&
            this.globalMfaValue === true &&
            value.mfa === false
          ) {
            this.$store.dispatch('authentication/logout');
          }
        })
        .catch(({ message }) => this.errorToast(message));
    },
    initModalUser(user) {
      this.activeUser = user;
      this.$bvModal.show('modal-user');
    },
    initModalDelete(user) {
      this.$bvModal
        .msgBoxConfirm(
          this.$t('pageUserManagement.modal.deleteConfirmMessage', {
            user: user.username,
          }),
          {
            title: this.$tc('pageUserManagement.deleteUser'),
            okTitle: this.$tc('pageUserManagement.deleteUser'),
            cancelTitle: this.$t('global.action.cancel'),
          }
        )
        .then((deleteConfirmed) => {
          if (deleteConfirmed) {
            this.deleteUser(user);
          }
        });
    },
    initModalSettings() {
      this.$bvModal.show('modal-settings');
    },
    saveUser({ isNewUser, userData, mfaBypass }) {
      this.startLoader();
      this.isBusy = true;
      if (isNewUser) {
        this.$store
          .dispatch('userManagement/createUser', userData)
          .then(async (success) => {
            this.successToast(success);
            if (mfaBypass) {
              await this.$store.dispatch(
                'userManagement/updateMfaBypassNewUser',
                {
                  userData,
                  mfaBypass,
                }
              );
            }
          })
          .catch(({ message }) => this.errorToast(message))
          .finally(() => {
            this.isBusy = false;
            this.endLoader();
          });
      } else {
        this.$store
          .dispatch('userManagement/updateUserfromUserManagement', userData)
          .then((success) => this.successToast(success))
          .catch(({ message }) => this.errorToast(message))
          .finally(() => {
            this.isBusy = false;
            this.endLoader();
          });
      }
    },
    deleteUser({ username }) {
      this.startLoader();
      this.$store
        .dispatch('userManagement/deleteUser', username)
        .then((success) => this.successToast(success))
        .catch(({ message }) => this.errorToast(message))
        .finally(() => this.endLoader());
    },
    onBatchAction(action) {
      switch (action) {
        case 'delete':
          this.$bvModal
            .msgBoxConfirm(
              this.$tc(
                'pageUserManagement.modal.batchDeleteConfirmMessage',
                this.selectedRows.length
              ),
              {
                title: this.$tc(
                  'pageUserManagement.deleteUser',
                  this.selectedRows.length
                ),
                okTitle: this.$tc(
                  'pageUserManagement.deleteUser',
                  this.selectedRows.length
                ),
                cancelTitle: this.$t('global.action.cancel'),
              }
            )
            .then((deleteConfirmed) => {
              if (deleteConfirmed) {
                this.startLoader();
                this.$store
                  .dispatch('userManagement/deleteUsers', this.selectedRows)
                  .then((messages) => {
                    messages.forEach(({ type, message }) => {
                      if (type === 'success') this.successToast(message);
                      if (type === 'error') this.errorToast(message);
                    });
                  })
                  .finally(() => this.endLoader());
              }
            });
          break;
        case 'enable':
          this.startLoader();
          this.$store
            .dispatch('userManagement/enableUsers', this.selectedRows)
            .then((messages) => {
              messages.forEach(({ type, message }) => {
                if (type === 'success') this.successToast(message);
                if (type === 'error') this.errorToast(message);
              });
            })
            .finally(() => this.endLoader());
          break;
        case 'disable':
          this.startLoader();
          this.$store
            .dispatch('userManagement/disableUsers', this.selectedRows)
            .then((messages) => {
              messages.forEach(({ type, message }) => {
                if (type === 'success') this.successToast(message);
                if (type === 'error') this.errorToast(message);
              });
            })
            .finally(() => this.endLoader());
          break;
      }
    },
    onTableRowAction(action, row) {
      switch (action) {
        case 'edit':
          this.initModalUser(row);
          break;
        case 'delete':
          this.initModalDelete(row);
          break;
        default:
          break;
      }
    },
    saveAccountSettings(settings) {
      this.startLoader();
      this.isBusy = true;
      this.$store
        .dispatch('userManagement/saveAccountSettings', settings)
        .then((message) => this.successToast(message))
        .catch(({ message }) => this.errorToast(message))
        .finally(() => {
          this.endLoader();
          this.isBusy = false;
        });
    },
    async updateGlobalMfa(state) {
      await this.$store.dispatch('userManagement/checkCurrentUserMfaBypassed', {
        uri: this.currentUser['@odata.id'],
      });
      if (!this.globalMfaValue) {
        this.beforeMfa = true;
        this.$store
          .dispatch('userManagement/clearSecretKey')
          .then(() => {
            this.$store
              .dispatch('userManagement/generateSecretKey')
              .catch(() => {
                this.beforeMfa = false;
                this.errorToast(
                  this.$t('pageUserManagement.toast.errorEnableMfaAuto')
                );
                this.$bvModal.show('register-otp-modal');
              });
          })
          .catch(() => {
            this.beforeMfa = false;
            this.errorToast(
              this.$t('pageUserManagement.toast.errorEnableMfaAuto')
            );
            this.$bvModal.show('register-otp-modal');
          });
      } else {
        this.$store
          .dispatch('userManagement/updateGlobalMfa', {
            globalMfa: state,
          })
          .then((message) => {
            this.successToast(message);
          })
          .catch(({ message }) => this.errorToast(message));
      }
    },
  },
};
</script>

<style lang="scss" scoped>
.btn.collapsed {
  svg {
    transform: rotate(180deg);
  }
}
</style>
